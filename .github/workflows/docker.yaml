name: å¤šæ¶æ„é•œåƒè½¬å­˜åˆ°é˜¿é‡Œäº‘

on:
  workflow_dispatch:

env:
  ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
  ALIYUN_NAME_SPACE: ${{ secrets.ALIYUN_NAME_SPACE }}
  ALIYUN_USER: ${{ secrets.ALIYUN_USER }}
  ALIYUN_PASS: ${{ secrets.ALIYUN_PASS }}

jobs:
  transfer-multiarch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½® QEMUï¼ˆè·¨æ¶æ„æ”¯æŒï¼‰
        uses: docker/setup-qemu-action@v3

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ env.ALIYUN_USER }}
          password: ${{ env.ALIYUN_PASS }}

      - name: æ„å»ºå¹¶æ¨é€å¤šæ¶æ„é•œåƒ
        run: |
          ACR_PREFIX="${ALIYUN_REGISTRY}/${ALIYUN_NAME_SPACE}"

          cat images.txt | while read line; do
            [[ -z "$line" || "$line" =~ ^#.* ]] && continue

            IFS=':' read -r SOURCE_IMAGE SOURCE_TAG <<< "$line"
            SOURCE_TAG=${SOURCE_TAG:-latest}
            SOURCE_FULL="docker.io/${SOURCE_IMAGE}:${SOURCE_TAG}"

            IMAGE_BASENAME=$(echo "$SOURCE_IMAGE" | sed 's|/|-|g')
            TARGET_IMAGE="${ACR_PREFIX}/${IMAGE_BASENAME}:${SOURCE_TAG}"

            echo "ğŸš€ è½¬å­˜é•œåƒ: $SOURCE_FULL â†’ $TARGET_IMAGE"

            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              --pull \
              --push \
              --tag $TARGET_IMAGE \
              --build-arg SOURCE_IMAGE=$SOURCE_FULL \
              - <<EOF
FROM \$SOURCE_IMAGE
EOF

          done
