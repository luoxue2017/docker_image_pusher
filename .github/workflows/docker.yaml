name: å¤šæ¶æ„é•œåƒè½¬å­˜åˆ°é˜¿é‡Œäº‘

on:
  workflow_dispatch:
  push:
    branches: [ main ]

env:
  ALIYUN_REGISTRY: "${{ secrets.ALIYUN_REGISTRY }}"
  ALIYUN_NAME_SPACE: "${{ secrets.ALIYUN_NAME_SPACE }}"
  ALIYUN_USER: "${{ secrets.ALIYUN_REGISTRY_USER }}"
  ALIYUN_PASS: "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}"
jobs:
  transfer-multiarch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½® QEMUï¼ˆè·¨æ¶æ„æ”¯æŒï¼‰
        uses: docker/setup-qemu-action@v3

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•é˜¿é‡Œäº‘é•œåƒä»“åº“
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ env.ALIYUN_USER }}
          password: ${{ env.ALIYUN_PASS }}

      - name: æ„å»ºå¹¶æ¨é€å¤šæ¶æ„é•œåƒ
        run: |
          ACR_PREFIX="${ALIYUN_REGISTRY}/${ALIYUN_NAME_SPACE}"

          cat images.txt | while read line; do
            [[ -z "$line" || "$line" =~ ^#.* ]] && continue

            IFS=':' read -r SOURCE_IMAGE SOURCE_TAG <<< "$line"
            SOURCE_TAG=${SOURCE_TAG:-latest}
            SOURCE_FULL="docker.io/${SOURCE_IMAGE}:${SOURCE_TAG}"
            # åˆ¤æ–­æ˜¯å¦å¸¦ä»“åº“å‰ç¼€ï¼ˆå³æ˜¯å¦åŒ…å«/ä¸”ç¬¬ä¸€ä¸ªéƒ¨åˆ†ä¸­æœ‰.æˆ–:ï¼‰
            if [[ "$SOURCE_IMAGE" =~ ^[a-zA-Z0-9.-]+(:[0-9]+)?/ ]]; then
               SOURCE_FULL="${SOURCE_IMAGE}:${SOURCE_TAG}"
            else
               SOURCE_FULL="docker.io/${SOURCE_IMAGE}:${SOURCE_TAG}"
            fi
            IMAGE_BASENAME=$(echo "$SOURCE_IMAGE" | sed 's|/|-|g')
            TARGET_IMAGE="${ACR_PREFIX}/${IMAGE_BASENAME}:${SOURCE_TAG}"

            echo "ğŸš€ è½¬å­˜é•œåƒ: $SOURCE_FULL â†’ $TARGET_IMAGE"

            TMPDIR=$(mktemp -d)
            echo "FROM ${SOURCE_FULL}" > $TMPDIR/Dockerfile

            docker buildx build \
              --platform linux/amd64,linux/arm64 \
              --pull \
              --push \
              --tag $TARGET_IMAGE \
              -f $TMPDIR/Dockerfile \
              $TMPDIR

            rm -rf "$TMPDIR"
            echo "  $TARGET_IMAGE"
          done
